
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AeroVario Pro (Vanilla)</title>
    <style>
        /* --- RESET & CORE STYLES --- */
        :root {
            --neon-green: #a3e635;
            --neon-red: #ef4444;
            --neon-purple: #d8b4fe;
            --bg-color: #000000;
            --panel-bg: #111827;
            --text-white: #f3f4f6;
            --text-gray: #9ca3af;
        }

        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .w-full { width: 100%; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .font-bold { font-weight: 700; }
        .absolute { position: absolute; }
        .relative { position: relative; }

        /* --- SCREENS --- */
        #screen-start, #screen-hud {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.3s ease;
        }

        /* --- START SCREEN --- */
        .start-btn {
            background: var(--neon-green);
            color: black;
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(163, 230, 53, 0.4);
            transition: transform 0.1s;
        }
        .start-btn:active { transform: scale(0.95); }
        .secondary-btn {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            padding: 12px 24px;
            border-radius: 12px;
            margin-top: 10px;
            cursor: pointer;
        }

        /* --- HUD COMPONENTS --- */
        .top-bar {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 0.8rem;
            color: var(--text-gray);
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        /* GPS Status */
        #gps-status { padding: 5px 10px; border-radius: 4px; transition: color 0.3s; }
        #gps-status.error-clickable {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--neon-red);
            animation: pulse-border 2s infinite;
            cursor: pointer;
        }

        .icon-btn {
            background: #1f2937; border: none; color: white;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer;
        }

        /* Main Layout */
        .hud-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow: hidden;
        }

        /* Section 1: Vario & Bar */
        .vario-section {
            display: flex;
            height: 140px; /* Increased height for Compass */
            gap: 8px;
            flex-shrink: 0;
        }

        /* Vario Bar */
        .vario-container {
            width: 30px;
            background: #1f2937;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid #374151;
        }
        .vario-center-line {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
            background: rgba(255,255,255,0.3); z-index: 10;
        }
        .vario-bar {
            position: absolute; left: 0; width: 100%;
            transition: height 0.1s linear, top 0.1s linear, bottom 0.1s linear, background-color 0.2s;
        }
        .tick { position: absolute; right: 0; width: 6px; height: 1px; background: #666; }

        /* Digital Vario Box */
        .digital-vario-box {
            flex: 1;
            background: rgba(17, 24, 39, 0.6);
            border-radius: 12px;
            display: flex;
            flex-direction: column; /* Stack Number then Compass */
            align-items: center;
            justify-content: center;
            border: 1px solid #374151;
            position: relative;
            padding: 5px;
        }
        #value-vario { font-size: 3rem; font-weight: 800; letter-spacing: -2px; line-height: 1; margin-top: 5px; }
        .climbing { color: var(--neon-green); }
        .sinking { color: var(--neon-red); }

        /* --- COMPASS STYLES --- */
        .compass-ring {
            width: 60px;
            height: 60px;
            border: 2px solid #374151;
            border-radius: 50%;
            position: relative;
            margin-top: 5px;
            background: radial-gradient(circle, #1f2937 20%, #000 100%);
            box-shadow: inset 0 0 10px #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .compass-label {
            position: absolute;
            font-size: 9px;
            font-weight: bold;
            color: #4b5563;
        }
        .lbl-n { top: 2px; left: 50%; transform: translateX(-50%); color: var(--neon-red); }
        .lbl-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .lbl-e { right: 3px; top: 50%; transform: translateY(-50%); }
        .lbl-w { left: 3px; top: 50%; transform: translateY(-50%); }

        .compass-arrow-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0; left: 0;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .compass-arrow {
            width: 0; 
            height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 30px solid var(--neon-green);
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -100%); /* Pivot bottom center */
            transform-origin: 50% 100%;
            filter: drop-shadow(0 0 4px rgba(163,230,53,0.5));
        }
        .compass-value-text {
            position: absolute; bottom: -12px; font-size: 9px; color: #6b7280; font-family: monospace;
        }

        /* Section 2: Thermal Radar (Canvas) */
        .radar-wrapper {
            flex: 1; /* Takes available space */
            background: #050505;
            border-radius: 12px;
            border: 1px solid #374151;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            min-height: 120px;
        }
        #thermal-canvas { width: 100%; height: 100%; }
        .radar-overlay-text {
            position: absolute; font-size: 9px; color: #4b5563; font-weight: bold; pointer-events: none;
        }
        .radar-orientation { top: 5px; left: 5px; color: var(--neon-green); }
        .radar-scale { bottom: 5px; right: 5px; }

        /* Section 3: Info Grid (Compact) */
        .info-grid {
            height: 80px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            flex-shrink: 0;
        }
        .card {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #374151;
        }
        .label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-gray); }
        .value { font-size: 1.1rem; font-weight: bold; text-align: right; }
        .unit { font-size: 0.65rem; color: var(--text-gray); text-align: right; }

        #btn-stop {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            width: calc(100% - 16px);
            margin: 0 8px 8px 8px;
            flex-shrink: 0;
        }

        /* --- MODALS & OVERLAYS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--neon-green); }
        
        /* SETTINGS STYLES */
        .setting-group {
            background: #1f2937; padding: 15px; border-radius: 10px;
            margin-bottom: 10px; border: 1px solid #374151;
        }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-inputs { border-top: 1px solid #374151; padding-top: 10px; margin-top: 10px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .input-row label { font-size: 0.8rem; color: #9ca3af; }
        
        input[type="number"], select {
            background: #000; color: white; border: 1px solid #4b5563;
            padding: 6px; border-radius: 6px; width: 100px; text-align: right;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--neon-green); }
        input:checked + .slider:before { transform: translateX(16px); }
        
        #alert-overlay {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: var(--neon-red); color: black; padding: 8px 16px;
            border-radius: 20px; font-weight: bold; z-index: 50;
            box-shadow: 0 0 15px var(--neon-red); display: none;
            animation: pulse 0.5s infinite alternate; width: 80%; text-align: center;
        }

        @keyframes pulse { from { opacity: 0.8; } to { opacity: 1; transform: translateX(-50%) scale(1.05); } }
        @keyframes pulse-border { 0% { border-color: var(--neon-red); } 50% { border-color: transparent; } 100% { border-color: var(--neon-red); } }
        .safe-area { padding-bottom: env(safe-area-inset-bottom); }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body>

    <!-- === START SCREEN === -->
    <div id="screen-start" class="flex flex-col items-center justify-center relative">
        <div style="position:absolute; top:0; width:100%; height:30%; background:radial-gradient(circle at top, rgba(163,230,53,0.1), transparent);"></div>
        <h1 style="font-size: 3rem; margin-bottom: 0;">AERO<span style="color:var(--neon-green)">VARIO</span></h1>
        <p style="color:var(--text-gray); letter-spacing: 2px; font-size: 0.8rem; margin-bottom: 40px;">PRO FLIGHT INSTRUMENT</p>
        <button id="btn-start" class="start-btn">INICIAR VUELO</button>
        <button id="btn-logs" class="secondary-btn">Historial</button>
        <div id="error-console" style="margin-top: 20px; color: red; font-size: 10px; max-width: 90%; white-space: pre-wrap;"></div>
    </div>

    <!-- === HUD SCREEN === -->
    <div id="screen-hud" class="hidden flex-col safe-area">
        <div id="alert-overlay">‚ö†Ô∏è ALARM</div>

        <!-- Top Bar -->
        <div class="top-bar">
            <button id="btn-settings" class="icon-btn">‚öôÔ∏è</button>
            <div id="gps-status" style="color: #eab308;">GPS: Inic...</div>
            <button id="btn-mute" class="icon-btn">üîä</button>
        </div>

        <div class="hud-content">
            <!-- Section 1: Vario & Compass -->
            <div class="vario-section">
                <div class="vario-container">
                    <div class="vario-center-line"></div>
                    <div id="vario-fill" class="vario-bar" style="height: 0; top: 50%;"></div>
                    <div id="ticks-container"></div>
                </div>
                <div class="digital-vario-box">
                    <span style="color:#6b7280; font-size:0.6rem; position:absolute; top:5px;">VARIO m/s</span>
                    <span id="value-vario" class="font-mono">+0.0</span>
                    
                    <!-- Digital Compass -->
                    <div class="compass-ring">
                        <span class="compass-label lbl-n">N</span>
                        <span class="compass-label lbl-e">E</span>
                        <span class="compass-label lbl-s">S</span>
                        <span class="compass-label lbl-w">W</span>
                        <div id="compass-needle" class="compass-arrow-container">
                            <div class="compass-arrow"></div>
                        </div>
                        <div id="compass-text" class="compass-value-text">0¬∞</div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Thermal Radar -->
            <div class="radar-wrapper">
                <canvas id="thermal-canvas"></canvas>
                <span class="radar-overlay-text radar-orientation">TRACK UP</span>
                <span class="radar-overlay-text radar-scale">200m</span>
            </div>

            <!-- Section 3: Grid Info -->
            <div class="info-grid">
                <div class="card" onclick="resetAlt()">
                    <span class="label">Altitud (MSL)</span>
                    <div><div id="value-alt" class="value font-mono">0</div><div class="unit">m</div></div>
                </div>
                <div class="card">
                    <span class="label">Velocidad</span>
                    <div><div id="value-speed" class="value font-mono">0</div><div class="unit">km/h</div></div>
                </div>
                <div class="card">
                    <span class="label">Planeo</span>
                    <div><div id="value-glide" class="value font-mono">--</div><div class="unit">L/D</div></div>
                </div>
            </div>
        </div>

        <button id="btn-stop">Finalizar Vuelo</button>
    </div>

    <!-- === SETTINGS MODAL === -->
    <div id="modal-settings" class="modal-overlay hidden">
        <div class="modal-header">
            <span class="modal-title">Configuraci√≥n</span>
            <button class="icon-btn" onclick="toggleModal('modal-settings', false)">‚úï</button>
        </div>
        <div id="settings-content">
            <!-- Generated via JS -->
        </div>
        <button onclick="saveSettingsAndClose()" class="start-btn w-full" style="margin-top:20px; padding:10px;">Guardar y Cerrar</button>
    </div>

    <!-- === LOGS MODAL === -->
    <div id="modal-logs" class="modal-overlay hidden">
        <div class="modal-header">
            <span class="modal-title">Historial</span>
            <button class="icon-btn" onclick="toggleModal('modal-logs', false)">‚úï</button>
        </div>
        <div id="logs-list"></div>
    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <script>
        const $ = (id) => document.getElementById(id);
        window.onerror = (msg, url, line) => $('error-console').innerText += `\nERR: ${msg}`;

        // --- STATE ---
        const DEFAULT_SETTINGS = {
            alerts: [
                { id: 'low_alt', type: 'ALTITUDE_LOW', enabled: false, threshold: 1000, sound: 'beep' },
                { id: 'sink_alarm', type: 'SINK_RATE', enabled: true, threshold: -2.5, duration: 2, sound: 'siren' }
            ]
        };
        
        let appState = {
            flying: false, muted: false, startTime: 0,
            flightData: { alt: 0, vario: 0, speed: 0, glide: 0, relAlt: 0, heading: 0, lat: 0, lon: 0 },
            stats: { maxAlt: -9999, maxClimb: 0, maxSink: 0 },
            takeoffAlt: null,
            settings: JSON.parse(localStorage.getItem('av_settings')) || DEFAULT_SETTINGS,
            trackHistory: [] // {lat, lon, vario, t}
        };

        // Ensure settings structure compatibility
        if (!appState.settings.alerts) appState.settings = DEFAULT_SETTINGS;

        // --- SETTINGS LOGIC ---
        function renderSettings() {
            const container = $('settings-content');
            container.innerHTML = '';

            appState.settings.alerts.forEach((alert) => {
                const isLowAlt = alert.type === 'ALTITUDE_LOW';
                const title = isLowAlt ? '‚ö†Ô∏è Baja Altitud' : '‚¨áÔ∏è Descenso Fuerte';
                const color = alert.enabled ? 'var(--neon-green)' : '#666';
                
                const html = `
                <div class="setting-group">
                    <div class="setting-header">
                        <span style="color:${color}; font-weight:bold;">${title}</span>
                        <label class="switch">
                            <input type="checkbox" ${alert.enabled ? 'checked' : ''} 
                                onchange="updateSetting('${alert.id}', 'enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    ${alert.enabled ? `
                    <div class="setting-inputs">
                        <div class="input-row">
                            <label>Umbral (${isLowAlt ? 'm' : 'm/s'})</label>
                            <input type="number" value="${alert.threshold}" step="${isLowAlt?10:0.1}"
                                onchange="updateSetting('${alert.id}', 'threshold', parseFloat(this.value))">
                        </div>
                        ${!isLowAlt ? `
                        <div class="input-row">
                            <label>Duraci√≥n (seg)</label>
                            <input type="number" value="${alert.duration||2}" 
                                onchange="updateSetting('${alert.id}', 'duration', parseFloat(this.value))">
                        </div>` : ''}
                        <div class="input-row">
                            <label>Sonido</label>
                            <select onchange="updateSetting('${alert.id}', 'sound', this.value)">
                                <option value="siren" ${alert.sound==='siren'?'selected':''}>Sirena</option>
                                <option value="beep" ${alert.sound==='beep'?'selected':''}>Beep</option>
                                <option value="whoop" ${alert.sound==='whoop'?'selected':''}>Whoop</option>
                                <option value="flatline" ${alert.sound==='flatline'?'selected':''}>Plano</option>
                            </select>
                        </div>
                    </div>` : ''}
                </div>`;
                container.innerHTML += html;
            });
        }

        window.updateSetting = (id, field, value) => {
            const alert = appState.settings.alerts.find(a => a.id === id);
            if (alert) {
                alert[field] = value;
                if (field === 'enabled') renderSettings(); // Re-render to show/hide inputs
            }
        };

        window.saveSettingsAndClose = () => {
            localStorage.setItem('av_settings', JSON.stringify(appState.settings));
            toggleModal('modal-settings', false);
        };

        // --- THERMAL RADAR LOGIC ---
        const canvas = $('thermal-canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const parent = canvas.parentElement;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = parent.clientWidth * dpr;
            canvas.height = parent.clientHeight * dpr;
            ctx.scale(dpr, dpr);
            canvas.logicalWidth = parent.clientWidth;
            canvas.logicalHeight = parent.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function drawRadar() {
            if (!appState.flying) return;
            const w = canvas.logicalWidth;
            const h = canvas.logicalHeight;
            const cx = w / 2;
            const cy = h / 2;
            
            ctx.clearRect(0, 0, w, h);

            // Draw Rings
            const maxDist = 250; 
            const scale = (Math.min(w, h) / 2) / maxDist; 

            ctx.strokeStyle = '#374151'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.arc(cx, cy, 100 * scale, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx, cy, 200 * scale, 0, Math.PI * 2); ctx.stroke();

            // Draw Pilot (Triangle)
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.moveTo(cx, cy - 6); ctx.lineTo(cx - 4, cy + 4); ctx.lineTo(cx + 4, cy + 4);
            ctx.fill();

            // Draw Track
            if (appState.trackHistory.length < 2) return;
            
            const currLat = appState.flightData.lat;
            const currLon = appState.flightData.lon;
            const headingRad = (appState.flightData.heading || 0) * (Math.PI / 180);
            const cosLat = Math.cos(currLat * (Math.PI / 180));
            const metersPerDegLat = 111132;
            const metersPerDegLon = 111319 * cosLat;

            for (let i = 0; i < appState.trackHistory.length; i++) {
                const p = appState.trackHistory[i];
                const dy = (p.lat - currLat) * metersPerDegLat;
                const dx = (p.lon - currLon) * metersPerDegLon;

                // Track Up Rotation
                const theta = -headingRad; 
                const rx = dx * Math.cos(theta) - dy * Math.sin(theta);
                const ry = dx * Math.sin(theta) + dy * Math.cos(theta);

                const px = cx + rx * scale;
                const py = cy - ry * scale;

                if (px < -10 || px > w+10 || py < -10 || py > h+10) continue;

                let radius = 2;
                if (p.vario > 2.0) { ctx.fillStyle = '#d8b4fe'; radius = 5; }
                else if (p.vario > 0.5) { ctx.fillStyle = '#ef4444'; radius = 3.5; }
                else { ctx.fillStyle = '#4b5563'; }

                const age = (Date.now() - p.t) / 1000; 
                if (age > 90) continue;

                ctx.beginPath(); ctx.arc(px, py, radius, 0, Math.PI * 2); ctx.fill();
            }
        }

        // --- KALMAN & FLIGHT LOGIC ---
        class KalmanFilter {
            constructor(R=1, Q=10) { this.R=R; this.Q=Q; this.x=NaN; this.p=NaN; }
            filter(z) {
                if(isNaN(this.x)) { this.x=z; this.p=this.Q; return z; }
                let pp = this.p + this.R;
                let k = pp / (pp + this.Q);
                this.x = this.x + k * (z - this.x);
                this.p = (1-k) * pp;
                return this.x;
            }
        }
        const altFilter = new KalmanFilter(0.5, 15);
        let altHistory = [];
        let sinkStartTime = 0, lastAlertTime = 0;

        function processFlightData(coords, timestamp) {
            const rawAlt = coords.altitude || 0;
            const filteredAlt = altFilter.filter(rawAlt);
            
            altHistory.push({ t: timestamp, alt: filteredAlt });
            altHistory = altHistory.filter(p => timestamp - p.t < 2000);
            let vario = 0;
            if (altHistory.length >= 2) {
                const first = altHistory[0];
                const last = altHistory[altHistory.length-1];
                vario = (last.alt - first.alt) / ((last.t - first.t)/1000);
            }

            const speedKmh = (coords.speed || 0) * 3.6;
            let glide = 0;
            if (vario < -0.5 && speedKmh > 5) glide = Math.abs((speedKmh/3.6)/vario);
            
            if (coords.heading && !isNaN(coords.heading) && speedKmh > 3) {
                appState.flightData.heading = coords.heading;
            }

            if (appState.takeoffAlt === null) appState.takeoffAlt = filteredAlt;
            appState.flightData.alt = Math.round(filteredAlt);
            appState.flightData.vario = parseFloat(vario.toFixed(1));
            appState.flightData.speed = Math.round(speedKmh);
            appState.flightData.glide = glide > 0 && glide < 50 ? glide.toFixed(1) : '--';
            appState.flightData.lat = coords.latitude;
            appState.flightData.lon = coords.longitude;

            if (coords.latitude && coords.longitude) {
                appState.trackHistory.push({
                    lat: coords.latitude, lon: coords.longitude, vario: vario, t: Date.now()
                });
                const cutoff = Date.now() - 90000;
                if (appState.trackHistory[0] && appState.trackHistory[0].t < cutoff) {
                    appState.trackHistory = appState.trackHistory.filter(p => p.t > cutoff);
                }
            }

            updateUI();
            drawRadar();
            audio.update(vario);
            checkAlerts(appState.flightData);
        }

        // --- AUDIO ENGINE ---
        class AudioEngine {
            constructor() { this.ctx=null; this.osc=null; this.isBeeping=false; }
            init() { 
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC(); this.gain = this.ctx.createGain(); this.gain.connect(this.ctx.destination);
            }
            playTone(freq, type, dur) {
                if(!this.ctx) return;
                const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                o.type=type; o.frequency.value=freq; o.connect(g); g.connect(this.gain);
                g.gain.value=0; g.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime+0.05);
                o.start();
                if(dur) { g.gain.linearRampToValueAtTime(0, this.ctx.currentTime+dur); o.stop(this.ctx.currentTime+dur+0.1); }
                return {o, g};
            }
            update(vario) {
                if(appState.muted) return;
                if(vario < -2.0) {
                    this.stopBeep();
                    if(!this.osc) { const s=this.playTone(200, 'sawtooth'); this.osc=s.o; }
                    if(this.osc) this.osc.frequency.value = Math.max(100, 300 + (vario*50));
                } else if(vario > 0.2) {
                    if(this.osc) { this.osc.stop(); this.osc=null; }
                    if(!this.isBeeping) { this.isBeeping=true; this.scheduleBeep(vario); }
                } else { this.stopAll(); }
            }
            scheduleBeep(vario) {
                if(!this.isBeeping) return;
                const v = Math.min(vario, 8);
                const period = Math.max(150, 600 - (v*60));
                this.playTone(400+(v*100), 'square', period*0.5/1000);
                this.timer = setTimeout(() => this.scheduleBeep(appState.flightData.vario), period);
            }
            stopBeep() { this.isBeeping=false; clearTimeout(this.timer); }
            stopAll() { this.stopBeep(); if(this.osc){try{this.osc.stop();}catch(e){} this.osc=null;} }
            playAlert(type) {
                if(appState.muted) return; this.stopAll();
                
                if(type === 'beep') {
                    // Double Beep pattern
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='square'; o.frequency.value=1500; o.connect(g); g.connect(this.gain);
                    const now = this.ctx.currentTime;
                    g.gain.setValueAtTime(0.3, now); g.gain.setValueAtTime(0, now+0.1);
                    g.gain.setValueAtTime(0.3, now+0.2); g.gain.setValueAtTime(0, now+0.3);
                    o.start(now); o.stop(now+0.3);
                } 
                else if(type === 'whoop') {
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='sine'; o.connect(g); g.connect(this.gain);
                    const now = this.ctx.currentTime;
                    o.frequency.setValueAtTime(300, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.4);
                    g.gain.setValueAtTime(0.5, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4);
                    o.start(now); o.stop(now+0.4);
                }
                else if(type === 'flatline') {
                    this.playTone(150, 'sawtooth', 0.8);
                }
                else {
                    // Default Siren
                    this.playTone(800, 'triangle', 0.6);
                }
            }
        }
        const audio = new AudioEngine();

        // --- UI & UTILS ---
        function updateUI() {
            const d = appState.flightData;
            $('value-vario').innerText = (d.vario>0?'+':'') + d.vario.toFixed(1);
            $('value-vario').className = d.vario > 0.1 ? 'climbing' : (d.vario < -0.1 ? 'sinking' : '');
            $('value-alt').innerText = d.alt;
            $('value-speed').innerText = d.speed;
            $('value-glide').innerText = d.glide;

            // Update Compass
            const h = d.heading || 0;
            $('compass-needle').style.transform = `rotate(${h}deg)`;
            $('compass-text').innerText = Math.round(h) + '¬∞';

            // Vario Bar
            const max=5, val=Math.max(-max, Math.min(max, d.vario));
            const bar=$('vario-fill');
            if(val>0) { bar.style.bottom='50%'; bar.style.top='auto'; bar.style.height=(val/max*50)+'%'; bar.style.background='var(--neon-green)'; }
            else { bar.style.top='50%'; bar.style.bottom='auto'; bar.style.height=(Math.abs(val)/max*50)+'%'; bar.style.background='var(--neon-red)'; }
        }

        function checkAlerts(data) {
            const now = Date.now();
            
            let activeAlert = null;
            let soundToPlay = null;

            appState.settings.alerts.forEach(a => {
                if(!a.enabled) return;
                
                // Low Alt
                if(a.type === 'ALTITUDE_LOW' && data.alt < a.threshold && data.alt > 0) { 
                    // Only alert if we haven't recently
                    if (now - lastAlertTime > 5000) {
                        activeAlert='BAJA ALTITUD'; 
                        soundToPlay = a.sound; 
                    }
                }
                
                // Sink Rate
                if(a.type === 'SINK_RATE') {
                    if (data.vario < a.threshold) {
                         if (!sinkStartTime) sinkStartTime = now;
                         else if ((now - sinkStartTime)/1000 > (a.duration || 2)) {
                             if (now - lastAlertTime > 3000) {
                                activeAlert='DESCENSO FUERTE';
                                soundToPlay = a.sound;
                             }
                         }
                    } else {
                        if (data.vario > a.threshold) sinkStartTime = 0;
                    }
                }
            });

            if(activeAlert && soundToPlay) { 
                $('alert-overlay').innerText='‚ö†Ô∏è '+activeAlert; 
                $('alert-overlay').style.display='block'; 
                audio.playAlert(soundToPlay);
                lastAlertTime=now; 
                setTimeout(()=>$('alert-overlay').style.display='none', 2500); 
            }
        }

        function initFlightSystem() {
            audio.init();
            if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') {
                 try{DeviceOrientationEvent.requestPermission();}catch(e){} 
            }
            $('screen-start').classList.add('hidden');
            $('screen-hud').classList.remove('hidden'); $('screen-hud').classList.add('flex');
            appState.flying = true;
            resizeCanvas(); 
            
            if('geolocation' in navigator) {
                $('gps-status').innerText = "GPS: Buscando...";
                navigator.geolocation.watchPosition(
                    pos => {
                        $('gps-status').innerText = "GPS: OK"; $('gps-status').style.color='var(--neon-green)';
                        processFlightData(pos.coords, pos.timestamp);
                    },
                    err => { $('gps-status').innerText = "GPS Error"; $('gps-status').style.color='var(--neon-red)'; $('gps-status').classList.add('error-clickable'); $('gps-status').onclick = () => location.reload(); },
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        $('btn-start').addEventListener('click', initFlightSystem);
        $('btn-stop').addEventListener('click', () => location.reload());
        $('btn-mute').addEventListener('click', () => { appState.muted = !appState.muted; $('btn-mute').innerText = appState.muted ? 'üîá' : 'üîä'; });
        $('btn-settings').addEventListener('click', () => toggleModal('modal-settings', true));
        
        function resetAlt() { appState.takeoffAlt = appState.flightData.alt; }
        function toggleModal(id, s) { $(id).className = s ? 'modal-overlay' : 'hidden'; if(s && id==='modal-settings') renderSettings(); }
        
        for(let i=1; i<=4; i++) { 
            $('ticks-container').innerHTML += `<div class="tick" style="top:${50-i*10}%"></div><div class="tick" style="top:${50+i*10}%"></div>`; 
        }
    </script>
</body>
</html>
