
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AeroVario Pro (Vanilla)</title>
    
    <!-- 1. LEAFLET CSS (FIRST) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <style>
        /* --- RESET & CORE STYLES --- */
        :root {
            --neon-green: #a3e635;
            --neon-red: #ef4444;
            --neon-purple: #d8b4fe;
            --neon-blue: #3b82f6;
            --neon-cyan: #06b6d4;
            --bg-color: #000000;
            --panel-bg: #111827;
            --text-white: #f3f4f6;
            --text-gray: #9ca3af;
        }

        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-white);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .w-full { width: 100%; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .font-bold { font-weight: 700; }
        .absolute { position: absolute; }
        .relative { position: relative; }

        /* --- SCREENS --- */
        #screen-start, #screen-hud {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.3s ease;
        }

        /* --- START SCREEN --- */
        .start-btn {
            background: var(--neon-green);
            color: black;
            border: none;
            padding: 20px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(163, 230, 53, 0.4);
            transition: transform 0.1s;
        }
        .start-btn:active { transform: scale(0.95); }
        .secondary-btn {
            background: #374151;
            color: white;
            border: 1px solid #4b5563;
            padding: 12px 24px;
            border-radius: 12px;
            margin-top: 10px;
            cursor: pointer;
        }

        /* --- HUD COMPONENTS --- */
        .top-bar {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 0.7rem;
            color: var(--text-gray);
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .status-group { display: flex; gap: 10px; font-weight: bold; }

        .status-badge { padding: 4px 6px; border-radius: 4px; transition: color 0.3s; border: 1px solid transparent; }
        .status-badge.error-clickable {
            background: rgba(239, 68, 68, 0.2); border-color: var(--neon-red); animation: pulse-border 2s infinite; cursor: pointer;
        }

        .icon-btn {
            background: #1f2937; border: none; color: white; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer;
        }

        /* Main Layout */
        .hud-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow: hidden;
        }

        /* Section 1: Vario & Bar (Top 30-40%) */
        .vario-section { display: flex; height: 130px; gap: 8px; flex-shrink: 0; }

        /* Vario Bar */
        .vario-container {
            width: 30px; background: #1f2937; border-radius: 15px; position: relative; overflow: hidden; border: 1px solid #374151;
        }
        .vario-center-line {
            position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.3); z-index: 10;
        }
        .vario-bar {
            position: absolute; left: 0; width: 100%;
            transition: height 0.1s linear, top 0.1s linear, bottom 0.1s linear, background-color 0.2s;
        }
        .tick { position: absolute; right: 0; width: 6px; height: 1px; background: #666; }

        /* Digital Vario Box */
        .digital-vario-box {
            flex: 1; background: rgba(17, 24, 39, 0.6); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid #374151; position: relative; padding: 5px;
        }
        #value-vario { font-size: 3rem; font-weight: 800; letter-spacing: -2px; line-height: 1; margin-top: 5px; }
        .climbing { color: var(--neon-green); }
        .sinking { color: var(--neon-red); }

        /* Compass */
        .compass-ring {
            width: 60px; height: 60px; border: 2px solid #374151; border-radius: 50%; position: relative;
            margin-top: 5px; background: radial-gradient(circle, #1f2937 20%, #000 100%);
            box-shadow: inset 0 0 10px #000; display: flex; justify-content: center; align-items: center;
        }
        .compass-label { position: absolute; font-size: 9px; font-weight: bold; color: #4b5563; }
        .lbl-n { top: 2px; left: 50%; transform: translateX(-50%); color: var(--neon-red); }
        .lbl-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .lbl-e { right: 3px; top: 50%; transform: translateY(-50%); }
        .lbl-w { left: 3px; top: 50%; transform: translateY(-50%); }
        .compass-arrow-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transition: transform 0.1s linear; }
        .compass-arrow {
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 30px solid var(--neon-green); position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%); transform-origin: 50% 100%; filter: drop-shadow(0 0 4px rgba(163,230,53,0.5));
        }
        .compass-value-text { position: absolute; bottom: -12px; font-size: 9px; color: #6b7280; font-family: monospace; }

        /* --- VIEW SWITCHER (TABS) --- */
        .view-switcher {
            display: flex; gap: 4px; margin-bottom: 0; flex-shrink: 0; height: 30px;
        }
        .view-tab {
            flex: 1; background: #111827; border: 1px solid #374151; border-bottom: none;
            color: #6b7280; font-size: 0.7rem; font-weight: bold; padding: 6px; border-radius: 8px 8px 0 0;
            cursor: pointer; transition: all 0.2s;
        }
        .view-tab.active {
            background: #050505; color: var(--neon-green); border-color: var(--neon-green); border-bottom: 1px solid #050505;
        }

        /* --- VISUALIZATION AREA (MAP/RADAR) --- */
        .vis-container {
            flex: 2; /* Take more vertical space (50% approx) */
            position: relative; 
            border: 1px solid #374151; 
            border-top: 1px solid var(--neon-green);
            background: #000; 
            border-radius: 0 0 12px 12px; 
            overflow: hidden; 
            min-height: 40vh; /* FORCE HEIGHT FOR IPHONE */
        }

        /* Thermal Radar & Graph */
        .radar-wrapper {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            display: flex; flex-direction: column; /* CHANGED to Column for Graph */
            justify-content: flex-start;
            align-items: stretch;
        }
        
        .radar-top-section {
            position: relative;
            flex: 1;
            min-height: 0; /* Important for flex child to shrink */
            width: 100%;
        }
        
        .alt-graph-section {
            height: 80px;
            width: 100%;
            border-top: 1px solid #1f2937;
            background: #050505;
            position: relative;
            flex-shrink: 0;
        }

        #thermal-canvas { width: 100%; height: 100%; }
        #alt-graph { width: 100%; height: 100%; }

        .radar-overlay-text { position: absolute; font-size: 9px; color: #4b5563; font-weight: bold; pointer-events: none; }
        .radar-orientation { top: 5px; left: 5px; color: var(--neon-green); }
        .radar-scale { bottom: 5px; right: 5px; }

        /* Leaflet Map Container */
        #map-wrapper {
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 10;
            display: none; /* Hidden by default */
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: #111; 
            border: 2px solid white; /* DEBUGGING BORDER - REMOVE LATER IF NEEDED */
            box-sizing: border-box;
            z-index: 1;
        }
        
        /* Dark Mode Map Filter */
        .leaflet-tile-pane { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-marker-icon { filter: none; }
        .leaflet-control-container .leaflet-top { top: 10px; }
        .leaflet-control-container .leaflet-bottom { bottom: 10px; }

        /* Info Grid */
        .info-grid {
            height: 70px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; flex-shrink: 0;
        }
        .card {
            background: var(--panel-bg); border-radius: 8px; padding: 6px;
            display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #374151;
        }
        .label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-gray); }
        .value { font-size: 1.1rem; font-weight: bold; text-align: right; }
        .unit { font-size: 0.65rem; color: var(--text-gray); text-align: right; }

        #btn-stop {
            background: rgba(239, 68, 68, 0.2); border: 1px solid var(--neon-red); color: var(--neon-red);
            padding: 12px; border-radius: 12px; font-weight: bold; text-transform: uppercase;
            width: calc(100% - 16px); margin: 0 8px 8px 8px; flex-shrink: 0;
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; /* Higher than map */
            display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--neon-green); }
        
        /* SETTINGS STYLES */
        .setting-group { background: #1f2937; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #374151; }
        .setting-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .setting-inputs { border-top: 1px solid #374151; padding-top: 10px; margin-top: 10px; }
        .input-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .input-row label { font-size: 0.8rem; color: #9ca3af; }
        
        input[type="number"], select { background: #000; color: white; border: 1px solid #4b5563; padding: 6px; border-radius: 6px; width: 100px; text-align: right; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--neon-green); }
        input:checked + .slider:before { transform: translateX(16px); }
        
        /* LOG STYLES - ADVANCED */
        .log-item { background: #1f2937; border: 1px solid #374151; border-radius: 10px; margin-bottom: 12px; overflow: hidden; transition: all 0.2s; }
        .log-summary { 
            padding: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            background: linear-gradient(90deg, #1f2937 0%, #111827 100%);
        }
        .log-summary:active { background: #374151; }
        
        .log-date { color: white; font-weight: bold; font-size: 0.95rem; }
        .log-basic-stats { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; display: flex; gap: 10px; }
        
        .log-details { 
            padding: 0 12px 12px 12px; background: #111; border-top: 1px solid #374151; 
            display: none; animation: slideDown 0.2s ease-out;
        }
        .log-details.open { display: block; }
        
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .detail-box { background: #1f2937; padding: 8px; border-radius: 6px; border: 1px solid #374151; }
        .d-label { font-size: 0.6rem; text-transform: uppercase; color: #6b7280; }
        .d-val { font-size: 0.9rem; font-weight: bold; color: #f3f4f6; font-family: monospace; }
        .d-unit { font-size: 0.7rem; color: #6b7280; }
        
        .btn-map-view {
            width: 100%; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #2563eb;
            padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; font-size: 0.8rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        .btn-delete-log {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.7; padding: 8px; color: #ef4444;
        }

        .btn-delete-all {
            background: rgba(239, 68, 68, 0.1); border: 1px solid #7f1d1d; color: #ef4444;
            padding: 12px; width: 100%; border-radius: 8px; margin-top: 20px;
            cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem;
        }

        /* Review Map specific */
        #review-map-container {
            flex: 1; border-radius: 12px; border: 1px solid #374151; overflow: hidden; background: #111;
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        #alert-overlay {
            position: absolute; top: 60px; left: 50%; transform: translateX(-50%);
            background: var(--neon-red); color: black; padding: 8px 16px;
            border-radius: 20px; font-weight: bold; z-index: 50;
            box-shadow: 0 0 15px var(--neon-red); display: none;
            animation: pulse 0.5s infinite alternate; width: 80%; text-align: center;
        }

        @keyframes pulse { from { opacity: 0.8; } to { opacity: 1; transform: translateX(-50%) scale(1.05); } }
        @keyframes pulse-border { 0% { border-color: var(--neon-red); } 50% { border-color: transparent; } 100% { border-color: var(--neon-red); } }
        .safe-area { padding-bottom: env(safe-area-inset-bottom); }
    </style>
    
    <!-- 2. LEAFLET JS (SECOND) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body>

    <!-- === START SCREEN === -->
    <div id="screen-start" class="flex flex-col items-center justify-center relative">
        <div style="position:absolute; top:0; width:100%; height:30%; background:radial-gradient(circle at top, rgba(163,230,53,0.1), transparent);"></div>
        <h1 style="font-size: 3rem; margin-bottom: 0;">AERO<span style="color:var(--neon-green)">VARIO</span></h1>
        <p style="color:var(--text-gray); letter-spacing: 2px; font-size: 0.8rem; margin-bottom: 40px;">PRO FLIGHT INSTRUMENT</p>
        <button id="btn-start" class="start-btn">INICIAR VUELO</button>
        <button id="btn-logs" class="secondary-btn">Historial</button>
        <div id="error-console" style="margin-top: 20px; color: red; font-size: 10px; max-width: 90%; white-space: pre-wrap;"></div>
        <p style="position:absolute; bottom:20px; left:20px; font-size:10px; color:#4b5563; opacity:0.7;">Created by: Spaciodnso</p>
    </div>

    <!-- === HUD SCREEN === -->
    <div id="screen-hud" class="hidden flex-col safe-area">
        <div id="alert-overlay">‚ö†Ô∏è ALARM</div>

        <!-- Top Bar -->
        <div class="top-bar">
            <button id="btn-settings" class="icon-btn">‚öôÔ∏è</button>
            <div class="status-group">
                <div id="gps-status" class="status-badge" style="color: #eab308;">GPS: Inic...</div>
                <div id="sat-status" class="status-badge" style="color: #4b5563;">SAT: --</div>
                <div id="compass-status" class="status-badge" style="color: #4b5563;">MAG: --</div>
            </div>
            <button id="btn-mute" class="icon-btn">üîä</button>
        </div>

        <div class="hud-content">
            <!-- Section 1: Vario & Compass -->
            <div class="vario-section">
                <div class="vario-container">
                    <div class="vario-center-line"></div>
                    <div id="vario-fill" class="vario-bar" style="height: 0; top: 50%;"></div>
                    <div id="ticks-container"></div>
                </div>
                <div class="digital-vario-box">
                    <span style="color:#6b7280; font-size:0.6rem; position:absolute; top:5px;">VARIO m/s</span>
                    <span id="value-vario" class="font-mono">+0.0</span>
                    
                    <!-- Digital Compass -->
                    <div class="compass-ring">
                        <span class="compass-label lbl-n">N</span>
                        <span class="compass-label lbl-e">E</span>
                        <span class="compass-label lbl-s">S</span>
                        <span class="compass-label lbl-w">W</span>
                        <div id="compass-needle" class="compass-arrow-container">
                            <div class="compass-arrow"></div>
                        </div>
                        <div id="compass-text" class="compass-value-text">0¬∞</div>
                    </div>
                </div>
            </div>

            <!-- View Switcher Tabs -->
            <div class="view-switcher">
                <button id="tab-radar" class="view-tab active" onclick="switchView('radar')">RADAR üéØ</button>
                <button id="tab-map" class="view-tab" onclick="switchView('map')">MAPA üó∫Ô∏è</button>
            </div>

            <!-- Section 2: Visual Container (Swappable) -->
            <div class="vis-container">
                <!-- Thermal Radar & Altitude Graph -->
                <div id="view-radar" class="radar-wrapper">
                    <!-- Top: Thermal Radar -->
                    <div class="radar-top-section">
                        <canvas id="thermal-canvas"></canvas>
                        <span class="radar-overlay-text radar-orientation">TRACK UP</span>
                        <span class="radar-overlay-text radar-scale">200m</span>
                    </div>
                    <!-- Bottom: Altitude Graph -->
                    <div class="alt-graph-section">
                        <canvas id="alt-graph"></canvas>
                        <span class="radar-overlay-text" style="top:2px; left:4px;">ALT (2m)</span>
                    </div>
                </div>

                <!-- Leaflet Map -->
                <div id="map-wrapper">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Section 3: Grid Info -->
            <div class="info-grid">
                <div class="card" onclick="resetAlt()">
                    <span class="label">Altitud (MSL)</span>
                    <div><div id="value-alt" class="value font-mono">0</div><div class="unit">m</div></div>
                </div>
                <div class="card">
                    <span class="label">Velocidad</span>
                    <div><div id="value-speed" class="value font-mono">0</div><div class="unit">km/h</div></div>
                </div>
                <div class="card">
                    <span class="label">Planeo</span>
                    <div><div id="value-glide" class="value font-mono">--</div><div class="unit">L/D</div></div>
                </div>
            </div>
        </div>

        <button id="btn-stop">Finalizar Vuelo</button>
    </div>

    <!-- === SETTINGS MODAL === -->
    <div id="modal-settings" class="modal-overlay hidden">
        <div class="modal-header">
            <span class="modal-title">Configuraci√≥n</span>
            <button class="icon-btn" onclick="toggleModal('modal-settings', false)">‚úï</button>
        </div>
        <div id="settings-content"></div>
        <button onclick="saveSettingsAndClose()" class="start-btn w-full" style="margin-top:20px; padding:10px;">Guardar y Cerrar</button>
    </div>

    <!-- === LOGS MODAL === -->
    <div id="modal-logs" class="modal-overlay hidden">
        <div class="modal-header">
            <span class="modal-title">Historial de Vuelos</span>
            <button class="icon-btn" onclick="toggleModal('modal-logs', false)">‚úï</button>
        </div>
        <div id="logs-list" class="w-full"></div>
    </div>
    
    <!-- === REVIEW MAP MODAL === -->
    <div id="modal-review" class="modal-overlay hidden">
        <div class="modal-header">
            <span class="modal-title">Ruta de Vuelo</span>
            <button class="icon-btn" onclick="closeReviewMap()">‚úï</button>
        </div>
        <div id="review-map-container"></div>
        <div style="text-align:center; font-size:10px; color:#666; margin-top:5px;">Cyan: Ruta de Vuelo</div>
    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <script>
        const $ = (id) => document.getElementById(id);
        window.onerror = (msg, url, line) => $('error-console').innerText += `\nERR: ${msg}`;

        // --- STATE ---
        const DEFAULT_SETTINGS = {
            alerts: [
                { id: 'low_alt', type: 'ALTITUDE_LOW', enabled: false, threshold: 1000, sound: 'beep' },
                { id: 'sink_alarm', type: 'SINK_RATE', enabled: true, threshold: -2.5, duration: 2, sound: 'siren' }
            ]
        };
        
        let appState = {
            flying: false, muted: false, startTime: 0,
            flightData: { alt: 0, vario: 0, speed: 0, glide: 0, relAlt: 0, heading: 0, lat: 0, lon: 0 },
            sensors: { magHeading: null },
            stats: { maxAlt: -9999, maxClimb: 0, maxSink: 0, maxSpeed: 0 },
            takeoffAlt: null,
            settings: JSON.parse(localStorage.getItem('av_settings')) || DEFAULT_SETTINGS,
            trackHistory: [], // For Radar (Short term)
            fullTrack: [],     // For Flight Log (Complete History)
            altHistory: [] // For Graph (Last 120 points)
        };

        // --- MAP & VIEW VARIABLES ---
        let mapInstance = null;
        let mapMarker = null;
        let mapPolyline = null;
        let currentView = 'radar'; // 'radar' or 'map'
        let isMapCentered = false; // Controls initial zoom

        // --- VIEW SWITCHING ---
        window.switchView = (view) => {
            currentView = view;
            
            // Update Tabs
            $('tab-radar').className = view === 'radar' ? 'view-tab active' : 'view-tab';
            $('tab-map').className = view === 'map' ? 'view-tab active' : 'view-tab';
            
            // Update Containers
            if (view === 'radar') {
                $('view-radar').style.display = 'flex';
                $('map-wrapper').style.display = 'none';
                resizeCanvas(); // Ensure redraw
            } else {
                $('view-radar').style.display = 'none';
                $('map-wrapper').style.display = 'block';
                
                // CRITICAL FIX: Invalidate Size when showing map
                setTimeout(() => {
                    if (mapInstance) {
                        mapInstance.invalidateSize();
                        // If we have a position, center map
                        if(appState.flightData.lat && appState.flightData.lon) {
                             mapInstance.panTo([appState.flightData.lat, appState.flightData.lon]);
                        }
                    }
                }, 100);
            }
        };

        // --- MAP INITIALIZATION ---
        function initMap() {
            if (mapInstance) return;
            
            // Create Map
            mapInstance = L.map('map', {
                zoomControl: false, // Cleaner UI
                attributionControl: false
            }).setView([0, 0], 2);

            // OpenStreetMap Tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(mapInstance);

            // Pilot Marker (Red Circle with white border)
            mapMarker = L.circleMarker([0,0], {
                radius: 8,
                fillColor: "#a3e635",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(mapInstance);

            // Flight Path (Blue Neon Line)
            mapPolyline = L.polyline([], {
                color: '#3b82f6', // Tailwind blue-500
                weight: 4,
                opacity: 0.8
            }).addTo(mapInstance);

            // CRITICAL FIX: Force resize calculation after init
            setTimeout(() => {
                mapInstance.invalidateSize();
            }, 500);
        }

        function updateMap(lat, lon) {
            if (!mapInstance || !lat || !lon) return;

            const latLng = [lat, lon];
            
            // Update Marker
            mapMarker.setLatLng(latLng);
            
            // Add to Track
            mapPolyline.addLatLng(latLng);

            // SMART ZOOM & CENTERING LOGIC
            if (!isMapCentered) {
                // First Fix: Hard Zoom (Jump) to level 17
                mapInstance.setView(latLng, 17);
                isMapCentered = true;
            } else if (currentView === 'map') {
                // Continuous Tracking: Smooth Pan
                mapInstance.panTo(latLng);
            }
        }

        // --- SETTINGS LOGIC ---
        function renderSettings() {
            const container = $('settings-content');
            container.innerHTML = '';

            appState.settings.alerts.forEach((alert) => {
                const isLowAlt = alert.type === 'ALTITUDE_LOW';
                const title = isLowAlt ? '‚ö†Ô∏è Baja Altitud' : '‚¨áÔ∏è Descenso Fuerte';
                const color = alert.enabled ? 'var(--neon-green)' : '#666';
                
                const html = `
                <div class="setting-group">
                    <div class="setting-header">
                        <span style="color:${color}; font-weight:bold;">${title}</span>
                        <label class="switch">
                            <input type="checkbox" ${alert.enabled ? 'checked' : ''} 
                                onchange="updateSetting('${alert.id}', 'enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    ${alert.enabled ? `
                    <div class="setting-inputs">
                        <div class="input-row">
                            <label>Umbral (${isLowAlt ? 'm' : 'm/s'})</label>
                            <input type="number" value="${alert.threshold}" step="${isLowAlt?10:0.1}"
                                onchange="updateSetting('${alert.id}', 'threshold', parseFloat(this.value))">
                        </div>
                        ${!isLowAlt ? `
                        <div class="input-row">
                            <label>Duraci√≥n (seg)</label>
                            <input type="number" value="${alert.duration||2}" 
                                onchange="updateSetting('${alert.id}', 'duration', parseFloat(this.value))">
                        </div>` : ''}
                        <div class="input-row">
                            <label>Sonido</label>
                            <select onchange="updateSetting('${alert.id}', 'sound', this.value)">
                                <option value="siren" ${alert.sound==='siren'?'selected':''}>Sirena</option>
                                <option value="beep" ${alert.sound==='beep'?'selected':''}>Beep</option>
                                <option value="whoop" ${alert.sound==='whoop'?'selected':''}>Whoop</option>
                                <option value="flatline" ${alert.sound==='flatline'?'selected':''}>Plano</option>
                            </select>
                        </div>
                    </div>` : ''}
                </div>`;
                container.innerHTML += html;
            });
        }

        window.updateSetting = (id, field, value) => {
            const alert = appState.settings.alerts.find(a => a.id === id);
            if (alert) {
                alert[field] = value;
                if (field === 'enabled') renderSettings(); 
            }
        };

        window.saveSettingsAndClose = () => {
            localStorage.setItem('av_settings', JSON.stringify(appState.settings));
            toggleModal('modal-settings', false);
        };

        // --- MATH UTILS ---
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- LOGS LOGIC ---
        function renderLogs() {
            const container = $('logs-list');
            container.innerHTML = '';
            // Load from new key 'glider_flight_history'
            const logs = JSON.parse(localStorage.getItem('glider_flight_history') || '[]');
            
            if(logs.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">No hay vuelos registrados</div>';
                return;
            }

            // Reverse order
            logs.sort((a,b) => b.startTime - a.startTime).forEach((log, index) => {
                const dateObj = new Date(log.startTime);
                const dateStr = dateObj.toLocaleDateString();
                const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Format Metrics
                const durH = Math.floor(log.totalTime / 3600);
                const durM = Math.floor((log.totalTime % 3600) / 60);
                const durS = Math.floor(log.totalTime % 60);
                const durationFmt = `${durH>0?durH+'h ':''}${durM}m ${durS}s`;
                
                const distKm = (log.totalDistance / 1000).toFixed(1);
                const gain = log.gain.toFixed(0);

                const hasRoute = log.route && log.route.length > 0;

                const html = `
                <div class="log-item">
                    <div class="log-summary" onclick="toggleLogDetails(${index})">
                        <div>
                            <div class="log-date">${dateStr} <span style="font-weight:normal; font-size:0.8em; color:#666">${timeStr}</span></div>
                            <div class="log-basic-stats">
                                <span>‚è±Ô∏è ${durationFmt}</span>
                                <span>üìè ${distKm} km</span>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:var(--neon-green)">+${gain}m</span>
                            <button class="btn-delete-log" onclick="event.stopPropagation(); deleteLog(${log.startTime})">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div id="log-det-${index}" class="log-details">
                        <div class="detail-grid">
                            <div class="detail-box">
                                <div class="d-label">Altitud Max</div>
                                <div class="d-val">${log.maxAlt} <span class="d-unit">m</span></div>
                            </div>
                             <div class="detail-box">
                                <div class="d-label">Alt Despegue</div>
                                <div class="d-val">${log.takeoffAlt} <span class="d-unit">m</span></div>
                            </div>
                            <div class="detail-box">
                                <div class="d-label">Max Ascenso</div>
                                <div class="d-val text-green-400">+${log.maxClimb} <span class="d-unit">m/s</span></div>
                            </div>
                             <div class="detail-box">
                                <div class="d-label">Max Descenso</div>
                                <div class="d-val text-red-400">${log.maxSink} <span class="d-unit">m/s</span></div>
                            </div>
                            <div class="detail-box">
                                <div class="d-label">Velocidad Max</div>
                                <div class="d-val">${log.maxSpeed} <span class="d-unit">km/h</span></div>
                            </div>
                            <div class="detail-box">
                                <div class="d-label">Vel Promedio</div>
                                <div class="d-val">${log.avgSpeed} <span class="d-unit">km/h</span></div>
                            </div>
                            <div class="detail-box">
                                <div class="d-label">Dist. Lineal</div>
                                <div class="d-val">${(log.linearDistance/1000).toFixed(1)} <span class="d-unit">km</span></div>
                            </div>
                        </div>
                        ${hasRoute ? `
                        <button class="btn-map-view" onclick="viewFlightMap(${log.startTime})">
                            üó∫Ô∏è Ver Mapa
                        </button>
                        ` : ''}
                    </div>
                </div>`;
                container.innerHTML += html;
            });

            container.innerHTML += `
                <button class="btn-delete-all" onclick="deleteAllLogs()">
                    ‚ö†Ô∏è Borrar Todo el Historial
                </button>
            `;
        }
        
        window.toggleLogDetails = (idx) => {
            const el = $(`log-det-${idx}`);
            if(el.style.display === 'block') el.style.display = 'none';
            else el.style.display = 'block';
        };

        window.deleteLog = (timestamp) => {
            if(confirm("¬øEliminar este vuelo?")) {
                let logs = JSON.parse(localStorage.getItem('glider_flight_history') || '[]');
                logs = logs.filter(l => l.startTime !== timestamp);
                localStorage.setItem('glider_flight_history', JSON.stringify(logs));
                renderLogs();
            }
        };

        window.deleteAllLogs = () => {
            if(confirm("¬°ATENCI√ìN! ¬øBorrar TODOS los vuelos? Acci√≥n irreversible.")) {
                localStorage.removeItem('glider_flight_history');
                renderLogs();
            }
        };
        
        // --- REVIEW MAP LOGIC ---
        let reviewMap = null;
        
        window.viewFlightMap = (startTime) => {
            const logs = JSON.parse(localStorage.getItem('glider_flight_history') || '[]');
            const log = logs.find(l => l.startTime === startTime);
            
            if(!log || !log.route || log.route.length === 0) {
                alert("No hay datos de ruta disponibles para este vuelo.");
                return;
            }
            
            // Show modal
            $('modal-review').classList.remove('hidden');
            
            // Init map if needed or reset
            if(reviewMap) {
                reviewMap.remove();
                reviewMap = null;
            }
            
            // Wait for display:block to take effect for size calculation
            setTimeout(() => {
                reviewMap = L.map('review-map-container', {
                     attributionControl: false
                }).setView([0,0], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                }).addTo(reviewMap);
                
                // Map route array {lat, lon, a} -> [lat, lon]
                const latlngs = log.route.map(p => [p.lat, p.lon]);
                
                // Draw Polyline (Neon Cyan)
                const polyline = L.polyline(latlngs, {
                    color: '#06b6d4', // Cyan
                    weight: 5,
                    opacity: 0.9
                }).addTo(reviewMap);
                
                // Start/End Markers
                L.circleMarker(latlngs[0], { color: '#a3e635', radius: 6, fillOpacity: 1 }).bindPopup('Despegue').addTo(reviewMap);
                L.circleMarker(latlngs[latlngs.length-1], { color: '#ef4444', radius: 6, fillOpacity: 1 }).bindPopup('Aterrizaje').addTo(reviewMap);
                
                // Fit bounds
                reviewMap.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                
            }, 100);
        };
        
        window.closeReviewMap = () => {
             $('modal-review').classList.add('hidden');
             if(reviewMap) {
                 reviewMap.remove();
                 reviewMap = null;
             }
        };

        function endFlight() {
            if (!appState.flying) return;
            
            const endTime = Date.now();
            const totalTimeSec = (endTime - appState.startTime) / 1000;
            
            // Only save if significant flight (> 10 sec and has track)
            if (totalTimeSec > 10 && appState.fullTrack.length > 1) {
                
                // --- 1. Distance Calculations ---
                let totalDist = 0;
                for(let i=1; i<appState.fullTrack.length; i++) {
                    const p1 = appState.fullTrack[i-1];
                    const p2 = appState.fullTrack[i];
                    totalDist += haversine(p1.lat, p1.lon, p2.lat, p2.lon);
                }

                // --- 2. Linear Distance ---
                const startPt = appState.fullTrack[0];
                const endPt = appState.fullTrack[appState.fullTrack.length-1];
                const linearDist = haversine(startPt.lat, startPt.lon, endPt.lat, endPt.lon);

                // --- 3. Speeds ---
                const avgSpeed = (totalDist / totalTimeSec) * 3.6; // m/s to km/h
                const maxSpeed = appState.stats.maxSpeed; // tracked live

                // --- 4. Altimetry ---
                const takeoffAlt = Math.round(startPt.alt);
                const maxAlt = appState.stats.maxAlt;
                const gain = maxAlt - takeoffAlt;

                const flightLog = {
                    startTime: appState.startTime,
                    endTime: endTime,
                    totalTime: totalTimeSec,
                    totalDistance: Math.round(totalDist), // meters
                    linearDistance: Math.round(linearDist), // meters
                    maxSpeed: Math.round(maxSpeed),
                    avgSpeed: parseFloat(avgSpeed.toFixed(1)),
                    takeoffAlt: takeoffAlt,
                    maxAlt: maxAlt,
                    gain: Math.max(0, gain), // Net gain
                    maxClimb: appState.stats.maxClimb.toFixed(1),
                    maxSink: appState.stats.maxSink.toFixed(1),
                    // Route optimization: Save raw for now, simplified to 4 decimals
                    route: appState.fullTrack.map(p => ({
                        lat: parseFloat(p.lat.toFixed(5)),
                        lon: parseFloat(p.lon.toFixed(5)),
                        a: Math.round(p.alt)
                    }))
                };
                
                // Save to localStorage 'glider_flight_history'
                const logs = JSON.parse(localStorage.getItem('glider_flight_history') || '[]');
                logs.push(flightLog);
                localStorage.setItem('glider_flight_history', JSON.stringify(logs));
            }
            
            location.reload();
        }

        // --- THERMAL RADAR & GRAPH LOGIC ---
        const thermalCanvas = $('thermal-canvas');
        const thermalCtx = thermalCanvas.getContext('2d');
        const altGraphCanvas = $('alt-graph');
        const altGraphCtx = altGraphCanvas.getContext('2d');
        
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            
            // Resize Thermal
            const thermalParent = thermalCanvas.parentElement;
            thermalCanvas.width = thermalParent.clientWidth * dpr;
            thermalCanvas.height = thermalParent.clientHeight * dpr;
            thermalCtx.scale(dpr, dpr);
            thermalCanvas.logicalWidth = thermalParent.clientWidth;
            thermalCanvas.logicalHeight = thermalParent.clientHeight;
            
            // Resize Alt Graph
            const graphParent = altGraphCanvas.parentElement;
            altGraphCanvas.width = graphParent.clientWidth * dpr;
            altGraphCanvas.height = graphParent.clientHeight * dpr;
            altGraphCtx.scale(dpr, dpr);
            altGraphCanvas.logicalWidth = graphParent.clientWidth;
            altGraphCanvas.logicalHeight = graphParent.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);

        function drawRadar() {
            if (!appState.flying || currentView !== 'radar') return; // Only draw if visible
            
            // --- THERMAL RADAR ---
            const w = thermalCanvas.logicalWidth;
            const h = thermalCanvas.logicalHeight;
            const cx = w / 2;
            const cy = h / 2;
            
            thermalCtx.clearRect(0, 0, w, h);

            // Draw Rings
            const maxDist = 250; 
            const scale = (Math.min(w, h) / 2) / maxDist; 

            thermalCtx.strokeStyle = '#374151'; thermalCtx.lineWidth = 1;
            thermalCtx.beginPath(); thermalCtx.arc(cx, cy, 100 * scale, 0, Math.PI * 2); thermalCtx.stroke();
            thermalCtx.beginPath(); thermalCtx.arc(cx, cy, 200 * scale, 0, Math.PI * 2); thermalCtx.stroke();

            // Draw Pilot (Triangle)
            thermalCtx.fillStyle = 'white';
            thermalCtx.beginPath();
            thermalCtx.moveTo(cx, cy - 6); thermalCtx.lineTo(cx - 4, cy + 4); thermalCtx.lineTo(cx + 4, cy + 4);
            thermalCtx.fill();

            if (appState.trackHistory.length >= 2) {
                const currLat = appState.flightData.lat;
                const currLon = appState.flightData.lon;
                const headingRad = (appState.flightData.heading || 0) * (Math.PI / 180);
                const cosLat = Math.cos(currLat * (Math.PI / 180));
                const metersPerDegLat = 111132;
                const metersPerDegLon = 111319 * cosLat;

                for (let i = 0; i < appState.trackHistory.length; i++) {
                    const p = appState.trackHistory[i];
                    const dy = (p.lat - currLat) * metersPerDegLat;
                    const dx = (p.lon - currLon) * metersPerDegLon;

                    // Track Up Rotation
                    const theta = -headingRad; 
                    const rx = dx * Math.cos(theta) - dy * Math.sin(theta);
                    const ry = dx * Math.sin(theta) + dy * Math.cos(theta);

                    const px = cx + rx * scale;
                    const py = cy - ry * scale;

                    if (px < -10 || px > w+10 || py < -10 || py > h+10) continue;

                    let radius = 2;
                    if (p.vario > 2.0) { thermalCtx.fillStyle = '#d8b4fe'; radius = 5; }
                    else if (p.vario > 0.5) { thermalCtx.fillStyle = '#ef4444'; radius = 3.5; }
                    else { thermalCtx.fillStyle = '#4b5563'; }

                    const age = (Date.now() - p.t) / 1000; 
                    if (age > 90) continue;

                    thermalCtx.beginPath(); thermalCtx.arc(px, py, radius, 0, Math.PI * 2); thermalCtx.fill();
                }
            }
        }
        
        function drawAltGraph() {
            if (!appState.flying || currentView !== 'radar') return;
            
            const w = altGraphCanvas.logicalWidth;
            const h = altGraphCanvas.logicalHeight;
            const ctx = altGraphCtx;
            
            ctx.clearRect(0, 0, w, h);
            
            const data = appState.altHistory;
            if(data.length < 2) return;
            
            // Find Min/Max for Scaling
            let min = Infinity, max = -Infinity;
            for(let v of data) {
                if(v < min) min = v;
                if(v > max) max = v;
            }
            
            // Add padding to range
            const range = max - min;
            const pad = (range === 0) ? 10 : range * 0.2;
            min -= pad;
            max += pad;
            
            ctx.beginPath();
            ctx.strokeStyle = '#a3e635'; // Neon Green
            ctx.lineWidth = 2;
            
            // X step
            const stepX = w / 119; // 120 points max
            
            for(let i=0; i<data.length; i++) {
                const x = i * stepX;
                // Invert Y: top is 0
                const norm = (data[i] - min) / (max - min);
                const y = h - (norm * h);
                
                if(i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Fill Gradient Effect (optional)
            ctx.lineTo((data.length-1)*stepX, h);
            ctx.lineTo(0, h);
            ctx.closePath();
            ctx.fillStyle = 'rgba(163, 230, 53, 0.1)';
            ctx.fill();
            
            // Min/Max Labels
            ctx.fillStyle = '#666';
            ctx.font = '10px monospace';
            ctx.fillText(Math.round(max), 2, 10);
            ctx.fillText(Math.round(min), 2, h-2);
        }

        // --- KALMAN & FLIGHT LOGIC ---
        class KalmanFilter {
            constructor(R=1, Q=10) { this.R=R; this.Q=Q; this.x=NaN; this.p=NaN; }
            filter(z) {
                if(isNaN(this.x)) { this.x=z; this.p=this.Q; return z; }
                let pp = this.p + this.R;
                let k = pp / (pp + this.Q);
                this.x = this.x + k * (z - this.x);
                this.p = (1-k) * pp;
                return this.x;
            }
        }
        const altFilter = new KalmanFilter(0.5, 15);
        let altHistory = [];
        let sinkStartTime = 0, lastAlertTime = 0;

        function processFlightData(coords, timestamp) {
            const rawAlt = coords.altitude || 0;
            const filteredAlt = altFilter.filter(rawAlt);
            
            altHistory.push({ t: timestamp, alt: filteredAlt });
            altHistory = altHistory.filter(p => timestamp - p.t < 2000);
            let vario = 0;
            if (altHistory.length >= 2) {
                const first = altHistory[0];
                const last = altHistory[altHistory.length-1];
                vario = (last.alt - first.alt) / ((last.t - first.t)/1000);
            }

            const speedKmh = (coords.speed || 0) * 3.6;
            let glide = 0;
            if (vario < -0.5 && speedKmh > 5) glide = Math.abs((speedKmh/3.6)/vario);
            
            let finalHeading = 0;
            if (speedKmh > 5 && coords.heading && !isNaN(coords.heading)) {
                finalHeading = coords.heading;
            } else if (appState.sensors.magHeading !== null) {
                finalHeading = appState.sensors.magHeading;
            } else if (coords.heading && !isNaN(coords.heading)) {
                finalHeading = coords.heading; 
            }
            appState.flightData.heading = finalHeading;

            if (appState.takeoffAlt === null) appState.takeoffAlt = filteredAlt;
            appState.flightData.alt = Math.round(filteredAlt);
            appState.flightData.vario = parseFloat(vario.toFixed(1));
            appState.flightData.speed = Math.round(speedKmh);
            appState.flightData.glide = glide > 0 && glide < 50 ? glide.toFixed(1) : '--';
            appState.flightData.lat = coords.latitude;
            appState.flightData.lon = coords.longitude;

            // Stats Update
            appState.stats.maxAlt = Math.max(appState.stats.maxAlt, appState.flightData.alt);
            appState.stats.maxClimb = Math.max(appState.stats.maxClimb, vario);
            appState.stats.maxSink = Math.min(appState.stats.maxSink, vario);
            appState.stats.maxSpeed = Math.max(appState.stats.maxSpeed, speedKmh);

            // Alt Graph History (Last 120 points)
            appState.altHistory.push(filteredAlt);
            if(appState.altHistory.length > 120) appState.altHistory.shift();

            if (coords.latitude && coords.longitude) {
                // Radar History (Short term, pruned)
                appState.trackHistory.push({
                    lat: coords.latitude, lon: coords.longitude, vario: vario, t: Date.now()
                });
                const cutoff = Date.now() - 90000;
                if (appState.trackHistory[0] && appState.trackHistory[0].t < cutoff) {
                    appState.trackHistory = appState.trackHistory.filter(p => p.t > cutoff);
                }
                
                // --- FULL LOG HISTORY (Filtered for memory) ---
                // Only store point if distance > 10m from last stored point to optimize
                const lastLogPt = appState.fullTrack[appState.fullTrack.length-1];
                let shouldLog = true;
                if(lastLogPt) {
                    // Quick crude distance check to avoid heavy haversine per frame
                    const dLat = Math.abs(coords.latitude - lastLogPt.lat);
                    const dLon = Math.abs(coords.longitude - lastLogPt.lon);
                    if(dLat < 0.0001 && dLon < 0.0001) shouldLog = false; 
                }
                
                if(shouldLog) {
                    appState.fullTrack.push({
                        lat: coords.latitude,
                        lon: coords.longitude,
                        alt: filteredAlt,
                        t: Date.now()
                    });
                }

                // Update Map
                updateMap(coords.latitude, coords.longitude);
            }

            updateUI();
            drawRadar();
            drawAltGraph(); // Update Graph
            audio.update(vario);
            checkAlerts(appState.flightData);
        }

        // --- AUDIO ENGINE ---
        class AudioEngine {
            constructor() { this.ctx=null; this.osc=null; this.isBeeping=false; }
            init() { 
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC(); this.gain = this.ctx.createGain(); this.gain.connect(this.ctx.destination);
            }
            playTone(freq, type, dur) {
                if(!this.ctx) return;
                const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                o.type=type; o.frequency.value=freq; o.connect(g); g.connect(this.gain);
                g.gain.value=0; g.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime+0.05);
                o.start();
                if(dur) { g.gain.linearRampToValueAtTime(0, this.ctx.currentTime+dur); o.stop(this.ctx.currentTime+dur+0.1); }
                return {o, g};
            }
            update(vario) {
                if(appState.muted) return;
                if(vario < -2.0) {
                    this.stopBeep();
                    if(!this.osc) { const s=this.playTone(200, 'sawtooth'); this.osc=s.o; }
                    if(this.osc) this.osc.frequency.value = Math.max(100, 300 + (vario*50));
                } else if(vario > 0.2) {
                    if(this.osc) { this.osc.stop(); this.osc=null; }
                    if(!this.isBeeping) { this.isBeeping=true; this.scheduleBeep(vario); }
                } else { this.stopAll(); }
            }
            scheduleBeep(vario) {
                if(!this.isBeeping) return;
                const v = Math.min(vario, 8);
                const period = Math.max(150, 600 - (v*60));
                this.playTone(400+(v*100), 'square', period*0.5/1000);
                this.timer = setTimeout(() => this.scheduleBeep(appState.flightData.vario), period);
            }
            stopBeep() { this.isBeeping=false; clearTimeout(this.timer); }
            stopAll() { this.stopBeep(); if(this.osc){try{this.osc.stop();}catch(e){} this.osc=null;} }
            playAlert(type) {
                if(appState.muted) return; this.stopAll();
                if(type === 'beep') {
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='square'; o.frequency.value=1500; o.connect(g); g.connect(this.gain);
                    const now = this.ctx.currentTime;
                    g.gain.setValueAtTime(0.3, now); g.gain.setValueAtTime(0, now+0.1);
                    g.gain.setValueAtTime(0.3, now+0.2); g.gain.setValueAtTime(0, now+0.3);
                    o.start(now); o.stop(now+0.3);
                } 
                else if(type === 'whoop') {
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='sine'; o.connect(g); g.connect(this.gain);
                    const now = this.ctx.currentTime;
                    o.frequency.setValueAtTime(300, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.4);
                    g.gain.setValueAtTime(0.5, now); g.gain.exponentialRampToValueAtTime(0.01, now+0.4);
                    o.start(now); o.stop(now+0.4);
                }
                else if(type === 'flatline') { this.playTone(150, 'sawtooth', 0.8); }
                else { this.playTone(800, 'triangle', 0.6); }
            }
        }
        const audio = new AudioEngine();

        // --- UI & UTILS ---
        function updateUI() {
            const d = appState.flightData;
            $('value-vario').innerText = (d.vario>0?'+':'') + d.vario.toFixed(1);
            $('value-vario').className = d.vario > 0.1 ? 'climbing' : (d.vario < -0.1 ? 'sinking' : '');
            $('value-alt').innerText = d.alt;
            $('value-speed').innerText = d.speed;
            $('value-glide').innerText = d.glide;

            // Update Compass
            const h = d.heading || 0;
            $('compass-needle').style.transform = `rotate(${h}deg)`;
            $('compass-text').innerText = Math.round(h) + '¬∞';

            // Vario Bar
            const max=5, val=Math.max(-max, Math.min(max, d.vario));
            const bar=$('vario-fill');
            if(val>0) { bar.style.bottom='50%'; bar.style.top='auto'; bar.style.height=(val/max*50)+'%'; bar.style.background='var(--neon-green)'; }
            else { bar.style.top='50%'; bar.style.bottom='auto'; bar.style.height=(Math.abs(val)/max*50)+'%'; bar.style.background='var(--neon-red)'; }
        }

        function checkAlerts(data) {
            const now = Date.now();
            let activeAlert = null;
            let soundToPlay = null;

            appState.settings.alerts.forEach(a => {
                if(!a.enabled) return;
                
                // Low Alt
                if(a.type === 'ALTITUDE_LOW' && data.alt < a.threshold && data.alt > 0) { 
                    if (now - lastAlertTime > 5000) {
                        activeAlert='BAJA ALTITUD'; 
                        soundToPlay = a.sound; 
                    }
                }
                
                // Sink Rate
                if(a.type === 'SINK_RATE') {
                    if (data.vario < a.threshold) {
                         if (!sinkStartTime) sinkStartTime = now;
                         else if ((now - sinkStartTime)/1000 > (a.duration || 2)) {
                             if (now - lastAlertTime > 3000) {
                                activeAlert='DESCENSO FUERTE';
                                soundToPlay = a.sound;
                             }
                         }
                    } else {
                        if (data.vario > a.threshold) sinkStartTime = 0;
                    }
                }
            });

            if(activeAlert && soundToPlay) { 
                $('alert-overlay').innerText='‚ö†Ô∏è '+activeAlert; 
                $('alert-overlay').style.display='block'; 
                audio.playAlert(soundToPlay);
                lastAlertTime=now; 
                setTimeout(()=>$('alert-overlay').style.display='none', 2500); 
            }
        }

        function initFlightSystem() {
            audio.init();
            initMap(); // Initialize Leaflet
            isMapCentered = false; // Reset zoom logic

            if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') {
                 try {
                     DeviceOrientationEvent.requestPermission().then(response => {
                        if(response === 'granted') { startSensors(); }
                        else { $('error-console').innerText += "\nPermiso Orientaci√≥n Denegado"; }
                     });
                 } catch(e){ $('error-console').innerText += "\nErr Permiso: "+e; }
            } else { startSensors(); }

            $('screen-start').classList.add('hidden');
            $('screen-hud').classList.remove('hidden'); $('screen-hud').classList.add('flex');
            
            appState.flying = true;
            appState.startTime = Date.now();
            appState.stats = { maxAlt: -9999, maxClimb: 0, maxSink: 0, maxSpeed: 0 };
            appState.takeoffAlt = null;
            appState.fullTrack = []; // Reset tracklog
            appState.altHistory = []; // Reset Graph
            
            resizeCanvas(); 
            // Initial view switch ensures sizes are correct
            switchView('radar');
            
            if('geolocation' in navigator) {
                $('gps-status').innerText = "GPS: Buscando...";
                navigator.geolocation.watchPosition(
                    pos => {
                        $('gps-status').innerText = "GPS: OK"; $('gps-status').style.color='var(--neon-green)';
                        
                        // --- SAT & ACCURACY ESTIMATION ---
                        // iOS/Web doesn't provide sat count. We estimate based on accuracy.
                        // <5m = ~12 sats, <10m = ~9 sats, <20m = ~6 sats, else 4
                        const acc = pos.coords.accuracy || 50;
                        const sats = acc <= 5 ? 12 : (acc <= 10 ? 10 : (acc <= 20 ? 7 : 4));
                        const satEl = $('sat-status');
                        satEl.innerText = `SAT: ${sats}`;
                        satEl.style.color = sats >= 10 ? 'var(--neon-green)' : (sats >= 7 ? '#eab308' : 'var(--text-gray)');
                        // ---------------------------------

                        processFlightData(pos.coords, pos.timestamp);
                    },
                    err => { $('gps-status').innerText = "GPS Error"; $('gps-status').style.color='var(--neon-red)'; $('gps-status').classList.add('error-clickable'); $('gps-status').onclick = () => location.reload(); },
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        function startSensors() {
            window.addEventListener('deviceorientation', (e) => {
                if (e.webkitCompassHeading) {
                    appState.sensors.magHeading = e.webkitCompassHeading;
                    const st = $('compass-status');
                    if(st.innerText !== "MAG: OK") { st.innerText = "MAG: OK"; st.style.color = 'var(--neon-green)'; }
                } 
                else if (e.alpha !== null) {
                     appState.sensors.magHeading = 360 - e.alpha; 
                     $('compass-status').innerText = "MAG: OK";
                }
            });
        }

        $('btn-start').addEventListener('click', initFlightSystem);
        $('btn-stop').addEventListener('click', endFlight);
        $('btn-logs').addEventListener('click', () => toggleModal('modal-logs', true));
        $('btn-mute').addEventListener('click', () => { appState.muted = !appState.muted; $('btn-mute').innerText = appState.muted ? 'üîá' : 'üîä'; });
        $('btn-settings').addEventListener('click', () => toggleModal('modal-settings', true));
        
        function resetAlt() { appState.takeoffAlt = appState.flightData.alt; }
        function toggleModal(id, s) { 
            $(id).className = s ? 'modal-overlay' : 'hidden'; 
            if(s && id==='modal-settings') renderSettings(); 
            if(s && id==='modal-logs') renderLogs();
        }
        
        for(let i=1; i<=4; i++) { 
            $('ticks-container').innerHTML += `<div class="tick" style="top:${50-i*10}%"></div><div class="tick" style="top:${50+i*10}%"></div>`; 
        }
    </script>
</body>
</html>
